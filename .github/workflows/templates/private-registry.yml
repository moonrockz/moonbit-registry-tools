# Private MoonBit Registry Template
#
# This workflow maintains a private registry that combines:
# - Mirrored packages from mooncakes.io
# - Your organization's private packages
#
# Copy this file to your repository's .github/workflows/ directory.
#
# Features:
# - Hybrid public/private package support
# - Git-based index for version control
# - Automatic deployment to GitHub Pages
# - Support for multiple upstream sources

name: Private Registry

on:
  push:
    branches: [main]
    paths:
      - 'packages/**'
      - 'registry.toml'

  schedule:
    # Sync public packages weekly
    - cron: '0 3 * * 0'

  workflow_dispatch:
    inputs:
      sync_public:
        description: 'Sync public packages from mooncakes'
        type: boolean
        default: true

concurrency:
  group: registry
  cancel-in-progress: false

env:
  REGISTRY_DIR: registry

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize registry
        uses: moonrockz/moonbit-registry-tools@main
        with:
          command: init
          registry-dir: ${{ env.REGISTRY_DIR }}
          registry-name: my-org-registry

      - name: Configure git remote
        uses: moonrockz/moonbit-registry-tools@main
        with:
          command: config
          registry-dir: ${{ env.REGISTRY_DIR }}
          config-key: git.remote_url
          config-value: ${{ github.server_url }}/${{ github.repository }}.git

      - name: Add mooncakes source
        uses: moonrockz/moonbit-registry-tools@main
        with:
          command: source-add
          registry-dir: ${{ env.REGISTRY_DIR }}
          source-name: mooncakes
          source-preset: mooncakes

      - name: Sync public packages
        if: github.event.inputs.sync_public != 'false' || github.event_name == 'schedule'
        uses: moonrockz/moonbit-registry-tools@main
        with:
          command: mirror
          registry-dir: ${{ env.REGISTRY_DIR }}
          # Customize which public packages to mirror
          patterns: |
            moonbitlang/core
            moonbitlang/x
          verbose: true

      # Add your private packages here
      # This step would copy your organization's packages into the registry
      - name: Add private packages
        run: |
          if [ -d "packages" ]; then
            echo "Copying private packages..."
            cp -r packages/* ${{ env.REGISTRY_DIR }}/data/packages/ 2>/dev/null || true
          fi

      - name: Commit changes
        run: |
          cd ${{ env.REGISTRY_DIR }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          if ! git diff --staged --quiet; then
            git commit -m "Update registry - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          fi

      - name: Push index
        uses: moonrockz/moonbit-registry-tools@main
        with:
          command: sync
          registry-dir: ${{ env.REGISTRY_DIR }}
          sync-mode: push

  deploy:
    needs: update
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare site
        run: |
          mkdir -p _site/git

          # Clone index as bare repo for git dumb HTTP protocol
          git clone --bare ${{ env.REGISTRY_DIR }}/data/index _site/git/index
          cd _site/git/index
          git update-server-info

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to Pages
        id: deployment
        uses: actions/deploy-pages@v4
