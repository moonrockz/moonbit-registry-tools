name: E2E Tests

on:
  workflow_dispatch:
    inputs:
      runner:
        description: 'Runner to use for E2E tests'
        required: true
        default: 'ubuntu-latest'
        type: choice
        options:
          - ubuntu-latest
          - macos-latest
          - windows-latest

# Allow only one E2E run at a time
concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    runs-on: ${{ inputs.runner }}
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup mise
        uses: jdx/mise-action@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install MoonBit toolchain (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> $GITHUB_PATH

      - name: Install MoonBit toolchain (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Set-ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
          irm https://cli.moonbitlang.com/install/powershell.ps1 | iex
          "$env:USERPROFILE\.moon\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Verify moon CLI
        run: moon version

      - name: Build CLI
        run: mise run build

      - name: Run E2E tests
        run: mise run test:e2e

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs-${{ inputs.runner }}
          path: |
            /tmp/moonbit-e2e-test-*/
          retention-days: 7
